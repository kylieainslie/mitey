---
title: "The Epidemiology of Scabies"
author: "Kylie Ainslie, Mariette Hooiveld, Jacco Wallinga"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
  word_document:
    toc: true
bibliography: references.bib
csl: nature.csl
vignette: >
  %\VignetteIndexEntry{epidemiology_of_scabies}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=7, 
  fig.height=4
)

options(rmarkdown.html_vignette.check_title = FALSE)
```

```{r setup, echo=FALSE, include = FALSE, results='hide'}
library(flextable)
library(ftExtra)
library(tidyr)
library(dplyr)
library(ggplot2)
library(cowplot)
library(brms)
library(officer)
library(devtools)
load_all()
```

## Introduction

Scabies is classified as a neglected tropical disease caused by infestation of the
skin with a microscopic mite (Sarcoptes scabiei) [@who]. Symptoms are
characterized by itchiness and rash at the site of infestation. Scabies
affects around 400 million people per year, and accounts for a large
proportion of skin disease in many low- and middle-income countries
[@who]. A rise in scabies cases has been observed through out Europe in
recent years [@deursen2022; @reichert2021; @redondo-bravo2021;
@lugovic-mihic2020; @amato2019; @dona2023]. 

Despite the considerable burden scabies poses annually,
little is known about the disease dynamics of scabies transmission, such
as the incubation time (time from exposure to symptom onset), generation time (time between infection of an index case and a secondary case), serial interval (the time from onset of symptoms in an
index case to the time of symptom onset in a secondary case), growth
rate, and reproduction number (the average number of secondary cases
resulting from one index case). 
A series of studies in the 1940s by Kenneth Mellanby [@mellanby1944]
form much of the basis of our current understanding of scabies
transmission. Some important results from Mellanby include... [Add key results from Mellanby 1944: curve of mites over time, time to symptom onset, probability of transmission from secondary objects]

In this work, we aim to estimate epidemiological characteristics of scabies.
It is critical to better understand the underlying disease dynamics of
scabies to 1) assess current spread and 2) inform infection control
policy. Some modelling work has been performed to study the potential
impacts of intervention strategies, such as mass drug administration, on
scabies transmission [@kinyanjui2018; @lydeamore2019; @tellioglu2023];
however, the values used to parameterise these models are based largely
on Mellanby's 1944 study and use information about the mite life-cycle
to approximate quantities such as latent period and infectious period.
However, this information doesn't necessarily provide good estimates for
transmission potential in humans. For example, Kinyanjui et al.
[@kinyanjui2018] assume a latent period of 7-14 days to allow for the
time for the time it takes for a fertilised female mite to reproduce and
incorporate it into a susceptible-exposed-infectious model of scabies
transmission. However, this assumes an equal chance of infectiousness
despite the number of mites inhabiting an infested indivual. Mellanby
[@mellanby1944] shows that the probability of onward transmission of
scabies is rare when the number of mites on an individual is low and
increases as the mite population grows. A better approximation of the
disease process can be obtained using the generation time or serial
interval; however, no such estimates exist for scabies.

Additionally, the growth rate and reproduction number are quantities
that describe how fast an infectious disease spreads. They are also used
to determine appropriate control measures to reduce the number of
secondary infections so that an epidemic dies out. However,
in the case of scabies, the basic reproduction number, the average number of secondary infections resulting from one index case in a completely susceptible population, has never been
described. This makes it immensely difficult to determine what level of
control measures are needed to contain disease spread. As evidence
continues to suggest that scabies is a growing problem in European countries and remains a large problem elsewhere, it is important to describe the epidemiological characteristics of scabies so that the required control efforts to curb scabies epidemics can be determined.

In this study, we use epidemic curves of scabies outbreaks from the
literature to estimate the serial interval. We use data on weekly
scabies cases in the Netherlands to estimate time-varying reproduction
number and annual growth rate. [not sure this should be in the intro]

## Methods

### Data Sources

We used publicly available data on reported symptom onset dates of scabies cases from previously published studies of scabies outbreaks (Table \@ref(tab:data_sources_table)) to estimate the serial interval of scabies. When the original study data was not provided, we reconstructed the data from the published epidemic curves. Additionally, we used data on the incidence of scabies over time in the Netherlands to estimate reproduction number and growth rate. These data have been described elsewhere [@deursen2022; @hasselaar]. Briefly, we obtained weekly incidence of scabies (per 1000 people) from 2011 to 2023 as diagnosed by general practitioners (GPs) that are stored in a nationally representative primary care database of GPs hosted by the Netherlands Institute for Health Services Research (Nivel) [@hasselaar]. Scabies is not a notifiable disease in the Netherlands, and thus information on scabies cases can only be obtained from GP diagnoses. Individuals in institutions (e.g., care homes) are generally not taken into account in these registrations. 

### Serial Interval

Using the dates of symptom onset for scabies cases from four different studies of scabies
outbreaks (Table \@ref(tab:si_results_tab)), we estimated the mean
and standard deviation of the serial interval distribution using the
method proposed by Vink et al. [@vink2014]. The method involves
calculating the index case-to-case (ICC) interval for each person, where
the person with the greatest value for number of days since symptom
onset will be considered the index case. The rest of the individuals
will have an ICC interval calculated as the number of days between their
symptom onset and the index case. We assumed a Normal serial interval
distribution. We performed a sensitivity analysis in which a Gamma
distribution was assumed as the serial interval distribution [TODO!].

We also performed a Bayesian meta-analysis using the `brms` package in R
[@burkner2017] to estimate the pooled mean serial interval. We used a
Bayesian hierarchical random-effects model. We chose to use a random
effects model because we assume that each study has its own “true”
serial interval, which has been sampled from an overarching distribution of
true serial intervals [@harrer]. We specified a prior distribution N(100,
50) for the true pooled mean and Cauchy(0,1) for the
between-study heterogeneity. 

[TODO!] We performed sensitivity analyses on our
choices of prior distributions.

### Growth rate

We estimated the annual growth rate of scabies cases by fitting an exponential growth model to annual incidence of scabies per 1000 people from 2011 to 2023 in the Netherlands [@nivel]. We assumed normally distributed errors, with mean zero and constant variance. Using the fitted exponential growth model and the estimated growth rate, we then determined the projected incidence of scabies per 1000 people until 2033 if no interventions are implemented and the growth rate remains constant. We used bootstrapping with 1000 samples to obtain 95% confidence bounds for the projected incidence of scabies per 1000 people.

### Reproduction Number

We obtained weekly reported cases of scabies per 1000 people from 2011 to 2023 in the Netherlands [@nivel; @deursen2022]. To estimate time-varying reproduction number, we first randomly assigned each reported case a date of symptom onset in the week in which the case was reported. Using the daily time series, we applied the method proposed by Wallinga and Teunis [@wallinga_teunis2004] to estimate the time-varying reproduction number by determining the likelihood of an event occurring for every pair of time points [@wallinga2007]. The method requires the specification of the serial interval distribution. We assumed a Normal serial interval distribution with mean 91.2 days and standard deviation 22.79 days, as estimated previously. To obtain confidence intervals on the daily reproduction number, we used bootstrapping. 
[TODO!] We performed a sensitivity analysis in which we assumed the serial interval was Gamma distributed.

All analyses were performed in R 4.4.0 [@R-base]. Additional R packages used in this work are cited in the Appendix.

## Results

### Serial Interval

We estimated the mean and standard deviation of the serial interval
using the epidemic curves from each study (Table \@ref(si_results_tab)). There was considerable variation between
studies with the largest estimated mean serial interval of 167.34 (SD =
9.72) from data from Kaburi et al. [@kaburi2019] which describes an
outbreak in a preschool in Ghana. The smallest estimated mean serial
interval was 16.11 (SD = 2.42), and was estimated from data from Larrosa
et al. [@larrosa2003] which describes an outbreak in a hospital in
Spain.

```{r si_results_tab, echo=FALSE, tab.cap="Estimated mean and standard deviation (SD) of serial interval distribution, in days, for each study."}
si_tab_dat <- data.frame(
  Study = c("Kaburi et al. 2019", 
            "Ariza et al. 2013", 
            "Akunzirwe et al. 2023", 
            "Tjon-Kon-Fat et al 2021."#, 
            #"Larosa et al. 2003", 
            #"Division of Public and Behavioral Health 2015"
            ),
  Details = c("Outbreak of scabies in a preschool in Ghana",
              "Outbreak of scabies in a preschool in Germany",
              "Outbreak of scabies in a fishing community in Uganda",
              "Outbreak of scabies in a nursing home in the Netherlands"#,
              #"Outbreak of scabies in a hospital in Spain",
              #"Outbreak of scabies in a long-term care facility in the USA"
              ),
  Mean = c(167.34, 98.4, 122.92, 110.71#, 16.11, 21.92
           ),
  SD = c(9.72, 8.54, 26.92, 16.14#, 2.42, 15.24
         ),
  Reference = c("[@kaburi2019]", "[@ariza2013]", "[@uganda]", "[@tjon-kon-fat2021]"#, 
                #"[@larrosa2003]", "[@nevada]"
                )
)

ft_si <- flextable(si_tab_dat) %>%
  autofit(add_w = 0.2) %>%
  bold(part = "header") %>%
  border_remove() %>%
  border(i = 1, border.top = officer::fp_border(width = 1), part = "header") %>%
  border(i = 1, border.bottom = officer::fp_border(width = 1), part = "header") %>%
  border(i = 4, border.bottom = officer::fp_border(width = 1), part = "body") 

ft_si
```

```{r si_dist_plot, echo=FALSE, eval=TRUE, fig.cap="Epidemic curves and estimated serial interval distributions from four scabies outbreaks. Red line indicates estimated serial interval density assuming an underlying normal distribution."}
knitr::include_graphics("figures/epidemic_curve_density_plot.png")
```

To obtain a pooled estimate of mean serial interval, we performed a
Bayesian meta-analysis with random intercepts for each study. We
estimated a pooled mean serial interval of 123.24 (95% credible interval: 91.44, 153.41)
(Figure \@ref(forest_plot). As we saw with the individual study
estimates (Table \@ref(si_results_tab)), the meta-analysis provided
further evidence of substantial heterogeneity among studies due to a
large value of the standard deviation of the random intercepts (31.55).
The large variation in the mean serial interval estimates can be
visualised by plotting the estimated distributions of each study's
serial interval shown in Figure \@ref(si_dist_plot). A normal
distribution is assumed, and is parameterized by the estimated mean and
standard deviation of serial interval for each study.


```{r forest_plot, echo = FALSE, eval = TRUE, fig.cap="Forest plot of estimated mean serial intervals and pooled mean."}
knitr::include_graphics("figures/meta-analysis_forest_plot.png")
```

### Growth Rate and Basic Reproduction Number

We estimated the annual growth rate of scabies cases by fitting an
exponential growth model to annual incidence of scabies per 1000 people
from 2011 to 2023 in the Netherlands [@nivel]. We estimated an annual
growth rate of 0.353 (95% CI: 0.152, 0.452). Using the estimated growth rate, we can estimate the basic reproduction number as R0 = 1 + (0.353 * 1/b), where b is the generation time in days [@wallinga2007]. Using the previously estimated pooled mean serial interval as a proxy for generation time, we estimate R0 = 1.002 (1.001, 1.004). Using the fitted exponential growth model and the estimated growth rate, we then
determined the projected incidence of scabies per 1000 people until 2033
if no interventions are implemented. We found that there could be a
substantial increase in scabies incidence in the next 10 years in the
Netherlands if no measures are taken to mitigate scabies spread (Figure
\@ref(fig:growth_rate_fig)).

```{r growth_rate_fig, echo=FALSE, message = FALSE, warning = FALSE, fig.align='center', fig.cap="Scabies incidence per 1000 people from 2011 to 2023 (points) and then projected scabies indcidence per 1000 people for 2024 to 2033 (line) using an exponential growth model with annual growth rate = 0.353. Shaded regions represent 95% confidence intervals for projected scabies incidence.", out.width="100%"}

# read in df for plot
scabies_plot_df <- readRDS("data/scabies_gr_proj_df.rds")

# Define the custom palette
custom_palette <- c("#21908C", "#440154") # Custom colors

# Plot with custom palette and specified line and point styles
ggplot(scabies_plot_df, aes(x = time, y = cases_mean, color = type, fill = type)) +
  # Points with no line through them
  geom_point(data = filter(scabies_plot_df, type == "Original Data"), aes(y = cases), size = 2, shape = 16) +

  # Line with points for other types
  geom_line(data = filter(scabies_plot_df, type != "Original Data"), aes(y = cases_mean), linewidth = 1.2) +
  geom_point(data = filter(scabies_plot_df, type != "Original Data"), aes(y = cases), size = 2, shape = 16) +

  # Ribbon for the confidence interval
  geom_ribbon(aes(ymin = cases_lower, ymax = cases_upper, fill = type), alpha = 0.2, color = NA) +

  # Labels and theme
  labs(x = "Year", y = "Incidence per 1000",
       color = "Data Type", fill = "Data Type") +
  scale_color_manual(values = custom_palette) +
  scale_fill_manual(values = custom_palette) +
  theme_minimal() +
  theme(legend.position = "right")

```

### Reproduction Number

We estimated time-varying reproduction number and plotted it against season. It appears that peak transmissibility occurs in the autumn and in some years extend into winter (Figure
\\\@ref(rt_plot)).

```{r rt_plot, echo=FALSE, fig.cap="Time-varying reproduction number of scabies transmission. Colored bands denote season. Winter = December 1 – February 28 (or 29 on leap year); Spring = March 1 – May 31; Summer = June 1 – August. 31; Autumn = September 1 – November 31.", out.width="100%"}
knitr::include_graphics("figures/rt_plot.png")
```
Note: This is a place-holder figure.

# Discussion

Still need to flush this out.

Discuss time-series trends and population that it typically occurs in in
NL (young adults/college students)

Discuss why estimates of mean serial interval across studies are so
different (different populations and identification of symptom onset may
be delayed).

Discuss limitations of the approach and caveats for interpretation.

# References

::: {#refs}
:::

# Appendix

```{r render_to_word, echo=FALSE, eval=FALSE}
# To render Word
rmarkdown::render("vignettes/epidemiology_of_scabies.Rmd", output_format = "word_document")
```
## Sensitivity Analyses

### Serial Interval
Assume Gamma distribution to estimate mean serial interval

```{r, si_results_gam, echo=FALSE, eval=TRUE}
# read in data
si_data <- readRDS("data/si_data.rds")

# assume a gamma distribution
result_gam <- si_data %>%
  select(icc_interval, study) %>%
  group_by(study) %>%
  summarise(result = list(si_estim(icc_interval, dist = "gamma"))) %>%
  mutate(
    mean = map_dbl(result, "mean"),
    sd = map_dbl(result, "sd"),
    wts = map(result, "wts")  # Store wts as a list-column
  ) %>%
  select(-result) %>%
  unnest(wts) %>% # Unnest the wts column if needed %>%
  pivot_longer(
    cols = c(mean, sd, wts),
    names_to = "statistic",
    values_to = "value"
  ) %>%
  group_by(study, statistic) %>%
  mutate(
    occurrence = row_number(),
    statistic = if_else(statistic == "wts", paste0("weight_", occurrence), statistic)
  ) %>%
  filter(statistic != "mean" | occurrence == 1) %>%
  filter(statistic != "sd" | occurrence == 1) %>%
  select(-occurrence) %>%
  ungroup()

# Plot serial interval curves
# Reshape results from long to wide format
result_gam_wide <- result_gam %>%
  pivot_wider(
    names_from = statistic,
    values_from = value
  )
```

```{r gam_table, echo=FALSE}
tab_si_gam <- flextable(result_gam_wide[,c(1:3)]) %>%
  autofit(add_w = 0.2) %>%
  bold(part = "header") %>%
  border_remove() %>%
  border(i = 1, border.top = officer::fp_border(width = 1), part = "header") %>%
  border(i = 1, border.bottom = officer::fp_border(width = 1), part = "header") %>%
  border(i = dim(result_gam_wide)[1], border.bottom = officer::fp_border(width = 1), part = "body") 

tab_si_gam
```

Meta-analysis results using Gamma distribution
```{r gam_eta_analysis_fig, echo=FALSE, eval=TRUE}
knitr::include_graphics("figures/gam_meta-analysis_forest_plot.png")
```

## TODO:

 - check prior assumptions for meta-analysis
 
 - more in-depth analysis of Rt
 
## Computing details
The additional R packages used in this work that have not previously been mentioned or cited in the main text are `fdrtool`[@fdrtool], `cowplot` [@cowplot], `devtools` [@devtools], `dplyr` [@dplyr], `usethis` [@usethis], `ggplot2` [@ggplot2]. 
[Packages to add: flextable, ftExtra, knitr, officer, rmarkdown, testthat]
